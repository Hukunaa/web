let button = document.getElementById("mint-button");
let account = document.getElementById('account-text');
let plus = document.getElementById('mint-plus');
let minus = document.getElementById('mint-minus');
let count = document.getElementById('mint-count');
let free_menu = document.getElementById('mint-free');
let free_button = document.getElementById('mint-free-button');
let free_text = document.getElementById('mint-free-text');

let contractAddress = '0xA74F58CF65dB65A28aC4c9a17e3f9efFC66a2F2C';
let contractABI = 'https://gateway.pinata.cloud/ipfs/QmNfg6wAuJBQX5U5QKjym9rg5jboxhXRNkjesi1oX2iW4C';
let countNumber = 1;

account.innerHTML = "Connect Metamask";
let accountWeb3;
let web3;
var contract;
const init = async() =>
{
    account.innerHTML = "Connecting to Metamask...";

    let provider = window.ethereum;
    if(typeof provider !== 'undefined')
    {
        web3 = new Web3(provider);
        const accs = await ethereum.request({method:'eth_requestAccounts'});
        accountWeb3 = accs[0];
        //web3.eth.getAccounts().then(e => accountWeb3 = e[0]);
        account.innerHTML = accountWeb3;
        //web3.eth.getAccounts().then(e => accountWeb3 = e[0]);
        provider.on('accountsChanged', function(accounts)
        {
            init();
        })
        
        fetch(contractABI).then(res => res.json()).then((out) => 
        {
            console.log(out);
            const networkID = web3.eth.net.getId();
            contract = new web3.eth.Contract(out.abi, contractAddress);
        }).catch(err => {console.log(err);});
    }
    else
    {
        account.innerHTML = "Ethereum provider is not installed!";
        button.style.display = "none";
        plus.style.display = "none";
        minus.style.display = "none";
        count.style.display = "none";
    }
}

free_button.addEventListener('click', function (event)
{
    contract.methods.getFreePlanet().estimateGas({from: accountWeb3}).then(function(gasAmount)
    {
      free_button.innerHTML = "Minting...";
    	contract.methods.getFreePlanet().send({from: accountWeb3, gas: gasAmount}).on('confirmation', function(confirmationNumber, receipt)
			{
        free_button.innerHTML = "Tx Success!";
        setTimeout(checkForFreePlanet, 500);
      }).on('error', function(error, receipt) 
            {
        free_button.innerHTML = "Tx Fail!";
      });
    });
});
plus.addEventListener('click', function (event) 
{
    if(countNumber < 5)
        countNumber += 1;
    
    count.innerHTML = countNumber.toString();
});

minus.addEventListener('click', function (event) 
{
    if(countNumber > 1)
        countNumber -= 1;

    count.innerHTML = countNumber.toString();
});

button.addEventListener('click', function (event) 
{
  event.preventDefault();
  if(accountWeb3 !== null)
  {
    let val = 0.025 * countNumber;
    button.innerHTML = "Minting...";
  	contract.methods.buyPlanet(countNumber).estimateGas({from: accountWeb3, value: web3.utils.toWei(val.toString(), 'ether')}).then(function(gasAmount)
    {
    	contract.methods.buyPlanet(countNumber).send({from: accountWeb3, gas: gasAmount, value: web3.utils.toWei(val.toString(), 'ether')}).on('confirmation', function(confirmationNumber, receipt)
        {
            button.innerHTML = "Tx Success!";
        }).on('error', function(error, receipt) 
        {
            button.innerHTML = "Tx Fail!";
        });
    });
  }
});
init();
